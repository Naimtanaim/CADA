<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>依客戶別棧位 (F_05) 1.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body {
    font-family: 'Microsoft JhengHei', sans-serif;
    background: #eee;
    margin: 20px;
    user-select: none;
  }
  .header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }
  .header label {
    font-weight: bold;
    white-space: nowrap;
  }
  input[type=text] {
    padding: 4px 6px;
    font-size: 18px;
    width: 140px;
  }
  .header .customer-info {
    font-size: 18px;
    white-space: nowrap;
    margin-left: 20px;
  }
  #btnSelect {
    margin-left: 12px;
    height: 37px;
    font-size: 18px;
    cursor: pointer;
  }
  table {
    width: 50%;
    border-collapse: collapse;
    background: white;
    margin-top: 12px;
    font-size: 16px;
  }
  th, td {
    border: 1px solid #bbb;
    padding: 6px 8px;
    text-align: center;
    vertical-align: middle;
  }
  th {
    background: #ddd;
  }
  td:first-child {
    width: 30px;
  }
  td:nth-child(2) {
    width: 60px;
  }
  td:nth-child(3) {
    width: 100px;
  }
  button.detail-btn {
    padding: 4px 8px;
    font-size: 13px;
    cursor: pointer;
  }
  #employeeName {
    font-weight: bold;
    margin-left: 10px;
    color: green;
  }
  #errorLog {
    margin-top: 12px;
    color: red;
    font-weight: bold;
  }
</style>
</head>
<body>
  <div class="header">
    <label for="employeeBarcode">員工條碼:</label>
    <input type="text" id="employeeBarcode" placeholder="" autofocus autocomplete="off" />
    <span id="employeeName"></span>
  </div>

  <div class="header" style="margin-top: 6px;">
    <label for="templateBarcode">客戶端位模板條碼:</label>
    <input type="text" id="templateBarcode" value="" />
    <div class="customer-info">客戶：<strong>H-149</strong></div>
    <div class="customer-info"><strong>H-149</strong></div>
    <label for="cartonBarcode" style="margin-left: 20px;">紙箱Barcode:</label>
    <input type="text" id="cartonBarcode" style="width: 180px;" />
    <button id="btnSelect">勾選務出棧板</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>項</th>
        <th>紙箱Barcode</th>
        <th>明細</th>
      </tr>
    </thead>
    <tbody id="barcodeList">
      <tr>
        <td><input type="checkbox" /></td>
        <td>80114</td>
        <td><button class="detail-btn">出貨明細</button></td>
      </tr>
      <tr>
        <td><input type="checkbox" /></td>
        <td>80125</td>
        <td><button class="detail-btn">出貨明細</button></td>
      </tr>
      <tr>
        <td><input type="checkbox" /></td>
        <td>80126</td>
        <td><button class="detail-btn">出貨明細</button></td>
      </tr>
      <tr>
        <td><input type="checkbox" /></td>
        <td>80041</td>
        <td><button class="detail-btn">出貨明細</button></td>
      </tr>
      <tr>
        <td><input type="checkbox" /></td>
        <td>80049</td>
        <td><button class="detail-btn">出貨明細</button></td>
      </tr>
    </tbody>
  </table>

  <div id="errorLog"></div>

<script>
  // Ganti dengan URL dan ANON KEY Supabase milikmu
  const SUPABASE_URL = 'https://uusljhegkvahcjkaxqkz.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1c2xqaGVna3ZhaGNqa2F4cWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODMzMTIsImV4cCI6MjA3MDA1OTMxMn0.eio4OSjH30XzfXn-9UxQRVwleGKi2dvdWo6Ggx8FW1g';

  // Inisialisasi client Supabase, jangan pakai nama 'supabase' karena bentrok global object
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const employeeBarcodeInput = document.getElementById('employeeBarcode');
  const employeeNameDisplay = document.getElementById('employeeName');
  const errorLog = document.getElementById('errorLog');

  let typingTimer;
  const doneTypingInterval = 500;

  employeeBarcodeInput.addEventListener('input', () => {
    clearTimeout(typingTimer);
    const barcode = employeeBarcodeInput.value.trim();

    if (!barcode) {
      employeeNameDisplay.textContent = '';
      errorLog.textContent = '';
      return;
    }

    typingTimer = setTimeout(async () => {
      employeeNameDisplay.textContent = '';
      employeeNameDisplay.style.color = 'black';
      errorLog.textContent = '';

      try {
        const { data, error } = await supabaseClient
          .from('employees')
          .select('name')
          .eq('barcode', barcode)
          .single();

        if (error) {
          errorLog.textContent = 'Supabase error: ' + error.message;
          employeeNameDisplay.textContent = '';
          employeeNameDisplay.style.color = 'red';
          console.error('Supabase error:', error);
          return;
        }

        if (!data) {
          employeeNameDisplay.textContent = '無此員工條碼';
          employeeNameDisplay.style.color = 'red';
          return;
        }

        employeeNameDisplay.textContent = data.name;
        employeeNameDisplay.style.color = 'green';
      } catch (err) {
        errorLog.textContent = 'Unexpected error: ' + err.message;
        employeeNameDisplay.textContent = '查詢失敗';
        employeeNameDisplay.style.color = 'red';
        console.error('Unexpected error:', err);
      }
    }, doneTypingInterval);
  });

  // Tombol detail pengiriman contoh
  document.querySelectorAll('.detail-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      alert('Tampilkan detail pengiriman untuk barcode ini.');
    });
  });

  // Tombol select checked barcode
  document.getElementById('btnSelect').addEventListener('click', () => {
    const checkedBarcodes = [...document.querySelectorAll('#barcodeList input[type=checkbox]:checked')]
      .map(cb => cb.closest('tr').children[1].textContent);

    if (checkedBarcodes.length === 0) {
      alert('請先勾選至少一個紙箱Barcode');
      return;
    }

    alert('Barcodes terpilih:\n' + checkedBarcodes.join('\n'));
  });
</script>
</body>
</html>
