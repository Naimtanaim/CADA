<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Penyimpanan Barang Otomatis</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body {
  font-family: Arial, sans-serif;
  background-color: #f4f6f9;
  margin: 0;
  padding: 30px;
}
.container {
  max-width: 850px;
  margin: auto;
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
h2 {
  text-align: center;
  color: #007bff;
  margin-bottom: 20px;
}
label {
  font-weight: bold;
  margin-right: 10px;
}
input[type=text] {
  padding: 8px;
  font-size: 16px;
  width: 200px;
}
button {
  padding: 5px 10px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
.delete-btn {
  background: #dc3545;
  color: white;
}
.delete-btn:hover {
  background: #b02a37;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}
th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
}
th {
  background: #007bff;
  color: white;
}

/* 🔔 Gaya notifikasi pop-up */
.notification {
  position: fixed;
  top: 60%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: red;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  padding: 20px 30px;
  z-index: 9999;
  display: none;
  font-size: 20px;
  text-align: center;
  animation: fadeIn 0.3s ease;
}
.notification.show {
  display: block;
}
.notification.success {
  border-left: 8px solid #28a745;
}
.notification.error {
  border-left: 8px solid #dc3545;
}
.notification.warning {
  border-left: 8px solid #ffc107;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translate(-50%, -60%); }
  to { opacity: 1; transform: translate(-50%, -50%); }
}
</style>
</head>
<body>
<div class="container">
  <h2>📦 Gudang Penyimpanan 存放位置</h2>

  <div>
    <label>Tempat 存放位置:</label>
    <input type="text" id="placeInput" placeholder="">
  </div>
  <br>
  <div>
    <label>Barcode:</label>
    <input type="text" id="barcodeInput" autofocus placeholder="">
  </div>

  <table>
    <thead>
      <tr>
        <th>No</th>
        <th>Barcode</th>
        <th>Customer</th>
        <th>Company No</th>
        <th>Qty</th>
        <th>Status</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- 🔔 Elemen notifikasi -->
<div id="popup" class="notification"></div>

<script>
const SUPABASE_URL = 'https://uusljhegkvahcjkaxqkz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1c2xqaGVna3ZhaGNqa2F4cWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODMzMTIsImV4cCI6MjA3MDA1OTMxMn0.eio4OSjH30XzfXn-9UxQRVwleGKi2dvdWo6Ggx8FW1g';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const barcodeInput = document.getElementById('barcodeInput');
const tableBody = document.getElementById('tableBody');
let lastCustomer = null;
let counter = 1;

// 🔔 Fungsi tampilkan notifikasi
function showPopup(message, type = "info", duration = 5000) {
  const popup = document.getElementById('popup');
  popup.textContent = message;
  popup.className = `notification show ${type}`;
  setTimeout(() => {
    popup.classList.remove('show');
  }, duration);
}

barcodeInput.addEventListener('change', async () => {
  const barcode = barcodeInput.value.trim();
  const place = document.getElementById('placeInput').value.trim();
  barcodeInput.disabled = true;

  if (!barcode) {
    showPopup('❌ Masukkan barcode terlebih dahulu!', 'error');
    barcodeInput.disabled = false;
    barcodeInput.focus();
    return;
  }

  // 🔍 Cek apakah barcode sudah ada di gudang_penyimpanan
  const { data: existing } = await supabaseClient
    .from('gudang_penyimpanan')
    .select('barcode')
    .eq('barcode', barcode)
    .maybeSingle();

  if (existing) {
    showPopup(`⚠️ Barcode ${barcode} sudah tersimpan sebelumnya.`, 'warning');
    barcodeInput.value = '';
    barcodeInput.disabled = false;
    barcodeInput.focus();
    return;
  }

  // 🔍 Cari data di tabel "data"
  const { data, error } = await supabaseClient
    .from('data')
    .select('*')
    .eq('box_number', barcode)
    .limit(1)
    .single();

  if (error || !data) {
    showPopup(`❌ Data untuk barcode ${barcode} tidak ditemukan!`, 'error');
    barcodeInput.disabled = false;
    barcodeInput.focus();
    return;
  }

  // 🔒 Cek konsistensi customer
  if (lastCustomer && data.customer !== lastCustomer) {
    showPopup(`❌ Customer berbeda dari sebelumnya!\n(${lastCustomer} ≠ ${data.customer})`, 'error', 3000);
    barcodeInput.value = '';
    barcodeInput.disabled = false;
    barcodeInput.focus();
    return;
  }

  // ✅ Simpan ke gudang_penyimpanan
  const payload = {
    packaging_board: data.packaging_board,
    box_number: data.box_number,
    material_order_number: data.material_order_number,
    original_material_order_number: data.original_material_order_number,
    company_number: data.company_number,
    packaging_quantity: data.packaging_quantity,
    customer: data.customer,
    customer_order_number: data.customer_order_number,
    delivery_order_number: data.delivery_order_number,
    packaging_time: data.packaging_time,
    packer: data.packer,
    barcode: barcode,
    place: place,
    saved_at: new Date().toISOString()
  };

  const { error: insertError } = await supabaseClient
    .from('gudang_penyimpanan')
    .insert([payload]);

  if (insertError) {
    showPopup(`❌ Gagal menyimpan: ${insertError.message}`, 'error');
  } else {
   showPopup(`✅ Barang ${barcode} berhasil disimpan di ${place}`, 'success');
    addRowToTable(barcode, data);
    lastCustomer = data.customer;
  }

  barcodeInput.value = '';
  barcodeInput.disabled = false;
  barcodeInput.focus();
});

// 🧾 Tambah baris baru di tabel
function addRowToTable(barcode, data) {
  const row = document.createElement('tr');
  row.innerHTML = `
    <td>${counter++}</td>
    <td>${barcode}</td>
    <td>${data.customer || '-'}</td>
    <td>${data.company_number || '-'}</td>
    <td>${data.packaging_quantity || '-'}</td>
    <td style="color:green;font-weight:bold;">✔️ Disimpan</td>
    <td><button class="delete-btn" onclick="deleteRow('${barcode}', this)">Hapus</button></td>
  `;
  tableBody.prepend(row);
  updateRowNumbers();
}

// 🗑️ Hapus data dari Supabase + tabel
async function deleteRow(barcode, btn) {
  if (!confirm(`Yakin ingin menghapus barcode ${barcode}?`)) return;

  const { error } = await supabaseClient
    .from('gudang_penyimpanan')
    .delete()
    .eq('barcode', barcode);

  if (error) {
    showPopup('❌ Gagal menghapus: ' + error.message, 'error');
  } else {
    btn.closest('tr').remove();
    updateRowNumbers();
    showPopup(`🗑️ Data ${barcode} telah dihapus.`, 'warning');
  }
}

// 🔢 Update nomor urut setelah hapus
function updateRowNumbers() {
  [...tableBody.rows].forEach((row, index) => {
    row.cells[0].textContent = index + 1;
  });
}
</script>
</body>
</html>
