<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>计时器</title>
  <style>
    * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body, html { margin: 0; padding: 0; background-color: #f9f9f9; font-size: 14px; }
    .container { display: flex; height: 55vh; padding: 10px; gap: 10px; }
    .left { flex: 2; display: flex; flex-direction: column; justify-content: center; padding: 15px; }
    .right { flex: 1; display: flex; align-items: center; justify-content: center; background: #222; color: #fff; font-size: 40px; font-weight: bold; border-radius: 8px; }
    label { margin: 6px 0 3px; font-weight: 600; font-size: 14px; }
    input, select { padding: 6px; font-size: 14px; margin-bottom: 10px; width: 100%; }
    button { padding: 8px 14px; font-size: 14px; border: none; color: white; border-radius: 4px; cursor: pointer; margin-right: 5px; }
    button:hover { opacity: 0.9; }
    #overtimeAlert {
      display: none;
      position: fixed; top: 40%; left: 50%;
      transform: translate(-50%, -50%);
      background-color: #ff4d4d;
      color: white;
      font-size: 20px;
      font-weight: bold;
      width: 450px;
      max-width: 90%;
      padding: 15px;
      text-align: center;
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(255, 0, 0, 0.4);
      z-index: 9999;
      animation: fadeInScale 0.4s ease-in-out;
    }
    @keyframes fadeInScale {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }
    .table-container { padding: 10px; background: #fff; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { border: 1px solid #ddd; padding: 5px; text-align: center; }
    th { background-color: #f4f4f4; }
    .filters { display: flex; gap: 5px; margin-bottom: 8px; }
    .filters input, .filters select { font-size: 13px; padding: 5px; }
    .top-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
@media print {
  body * { visibility: hidden; }
  .print-area, .print-area * { visibility: visible; }
  .print-area { position: absolute; left: 0; top: 0; width: 100%; }
  .filters, .top-actions button { display: none !important; }

  /* Sembunyikan kolom checkbox saat print */
  table thead th:first-child,
  table tbody td:first-child {
    display: none !important;
  }
}

  </style>
</head>
<body>

<div class="container">
  <div class="left">
    <h3 style="margin-top:0;">工作计时器</h3>
<label for="worker">👷‍♀️ 员工姓名:</label>
<select id="worker">
  <option value="">请选择员工姓名</option>
  <option value="张伟">张伟</option>
  <option value="李娜">李娜</option>
  <option value="王强">王强</option>
  <option value="刘洋">刘洋</option>
  <option value="陈芳">陈芳</option>
</select>
    <label for="item">📦 商品名称:</label>
    <input type="text" id="item" placeholder="请输入商品名称" />
    <label for="duration">⏱️ 工作时长（分钟）:</label>
    <input type="number" id="duration" placeholder="例如：30" min="1" />
    <label for="totalItems">📦 总共商品数量:</label>
    <input type="number" id="totalItems" placeholder="例如：50" min="1" />
    <div>
      <button style="background:#007bff;" onclick="startTimer()">开始</button>
      <button style="background:#dc3545;" onclick="stopTimer()">停止</button>
    </div>
  </div>
  <div class="right">
    <div id="timer">00:00</div>
  </div>
</div>

<div id="overtimeAlert">⛔ 时间已超出！</div>

<div class="table-container print-area">
  <div class="top-actions">
    <h3 style="margin:4;">📋 记录列表</h3>
    <div>
      <button style="background:#28a745;" onclick="printTable()">🖨️ 打印记录</button>
      <button style="background:#dc3545;" onclick="deleteSelected()">🗑️ 删除选中</button>
    </div>
  </div>
  <div class="filters">
    <input type="text" id="searchInput" placeholder="搜索员工或商品..." oninput="applyFilters()" />
    <select id="statusFilter" onchange="applyFilters()">
      <option value="">全部状态</option>
      <option value="完成">完成</option>
      <option value="超时">超时</option>
    </select>
  </div>
  <table>
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll" onclick="toggleAll(this)"></th>
        <th>员工姓名</th>
        <th>商品名称</th>
        <th>总共商品数量</th>
        <th>设定时长(分钟)</th>
        <th>开始时间</th>
        <th>结束时间</th>
        <th>状态</th>
      </tr>
    </thead>
    <tbody id="recordTable"></tbody>
  </table>
</div>

<script>
  const SUPABASE_URL = 'https://uusljhegkvahcjkaxqkz.supabase.co';  // 替换成你的 Supabase URL
  const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1c2xqaGVna3ZhaGNqa2F4cWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODMzMTIsImV4cCI6MjA3MDA1OTMxMn0.eio4OSjH30XzfXn-9UxQRVwleGKi2dvdWo6Ggx8FW1g';  // 替换成你的 Supabase API KEY
  const TABLE_NAME = 'timer';

  let timerInterval = null;
  let startTime = null;
  let durationInput = 0;
  let totalItemsInput = 0;
  let overtimeStarted = false;
  let allData = [];

  function formatTime(seconds) {
    const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
    const secs = String(seconds % 60).padStart(2, '0');
    return `${mins}:${secs}`;
  }

  function startTimer() {
    const worker = document.getElementById('worker').value.trim();
    const item = document.getElementById('item').value.trim();
    durationInput = parseInt(document.getElementById('duration').value.trim());
    totalItemsInput = parseInt(document.getElementById('totalItems').value.trim());

    if (!worker || !item || isNaN(durationInput) || durationInput <= 0 || isNaN(totalItemsInput) || totalItemsInput <= 0) {
      alert('请填写所有字段并输入有效的时长和总商品数量');
      return;
    }
    if (timerInterval) {
      alert('计时器已在运行中');
      return;
    }
    startTime = new Date();
    let seconds = 0;
    overtimeStarted = false;
    document.getElementById('overtimeAlert').style.display = 'none';
    document.getElementById('timer').textContent = '00:00';

    timerInterval = setInterval(async () => {
      seconds++;
      document.getElementById('timer').textContent = formatTime(seconds);

      if (seconds >= durationInput * 60 && !overtimeStarted) {
        overtimeStarted = true;
        showOvertimeAlert();
        clearInterval(timerInterval);
        timerInterval = null;
        try {
          await saveData(worker, item, durationInput, totalItemsInput, "超时");
          alert('超时数据已保存');
        } catch (e) {
          alert('保存超时数据失败: ' + e.message);
          console.error(e);
        }
        resetTimer();
      }
    }, 1000);
  }

  function stopTimer() {
    if (!timerInterval) {
      alert('计时器未在运行');
      return;
    }
    clearInterval(timerInterval);
    timerInterval = null;
    const worker = document.getElementById('worker').value.trim();
    const item = document.getElementById('item').value.trim();

    if (worker && item && startTime && !overtimeStarted) {
      saveData(worker, item, durationInput, totalItemsInput, "完成").then(() => {
        alert('完成数据已保存');
      }).catch(e => {
        alert('保存完成数据失败: ' + e.message);
        console.error(e);
      });
    }
    resetTimer();
  }

  function resetTimer() {
    document.getElementById('timer').textContent = "00:00";
  }

  function resetForm() {
    document.getElementById('worker').value = '';
    document.getElementById('item').value = '';
    document.getElementById('duration').value = '';
    document.getElementById('totalItems').value = '';
  }

  function showOvertimeAlert() {
    const alertBox = document.getElementById("overtimeAlert");
    alertBox.style.display = "block";
    setTimeout(() => { alertBox.style.display = "none"; }, 60000);
  }

  async function saveData(worker, item, duration, totalItems, status) {
    const endTime = new Date();
    if (!startTime) startTime = new Date();
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE_NAME}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_API_KEY,
          "Authorization": `Bearer ${SUPABASE_API_KEY}`,
          "Prefer": "return=representation"
        },
        body: JSON.stringify({
          worker_name: worker,
          item_name: item,
          duration_minutes: duration,
          total_items: totalItems,
          start_time: startTime.toISOString(),
          end_time: endTime.toISOString(),
          status: status
        })
      });
      if (!res.ok) {
        const errText = await res.text();
        throw new Error(`保存数据失败: ${res.status} - ${errText}`);
      }
      await fetchRecords();
      resetForm(); // Kosongkan input setelah berhasil simpan
    } catch (e) {
      console.error('Error saving data:', e);
      throw e;
    }
  }

  async function fetchRecords() {
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE_NAME}?select=*`, {
        headers: {
          "apikey": SUPABASE_API_KEY,
          "Authorization": `Bearer ${SUPABASE_API_KEY}`
        }
      });
      if (!res.ok) {
        const errText = await res.text();
        throw new Error(`获取数据失败: ${res.status} - ${errText}`);
      }
      allData = await res.json();
      applyFilters();
    } catch (e) {
      alert('获取数据时出错: ' + e.message);
      console.error(e);
    }
  }

  function applyFilters() {
    const searchValue = document.getElementById("searchInput").value.toLowerCase();
    const statusValue = document.getElementById("statusFilter").value;
    const filtered = allData.filter(row => {
      const matchSearch =
        (row.worker_name && row.worker_name.toLowerCase().includes(searchValue)) ||
        (row.item_name && row.item_name.toLowerCase().includes(searchValue));
      const matchStatus = statusValue ? row.status === statusValue : true;
      return matchSearch && matchStatus;
    });
    renderTable(filtered);
  }

  function renderTable(data) {
    const tbody = document.getElementById("recordTable");
    tbody.innerHTML = "";
    data.forEach(row => {
      const tr = document.createElement("tr");
      const statusColor = row.status === "超时" ? "red" : "black";
      tr.innerHTML = `
        <td><input type="checkbox" data-id="${row.id}"></td>
        <td>${row.worker_name || ''}</td>
        <td>${row.item_name || ''}</td>
        <td>${row.total_items || ''}</td>
        <td>${row.duration_minutes || ''}</td>
        <td>${row.start_time ? new Date(row.start_time).toLocaleString() : ''}</td>
        <td>${row.end_time ? new Date(row.end_time).toLocaleString() : ''}</td>
        <td style="color:${statusColor}; font-weight: bold;">${row.status || ''}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function toggleAll(source) {
    document.querySelectorAll('#recordTable input[type="checkbox"]').forEach(cb => cb.checked = source.checked);
  }

  async function deleteSelected() {
    const selectedIds = Array.from(document.querySelectorAll('#recordTable input[type="checkbox"]:checked'))
      .map(cb => cb.dataset.id);
    if (selectedIds.length === 0) {
      alert("请选择要删除的记录");
      return;
    }
    if (!confirm("确定要删除选中的记录吗？")) return;
    try {
      for (let id of selectedIds) {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE_NAME}?id=eq.${id}`, {
          method: "DELETE",
          headers: {
            "apikey": SUPABASE_API_KEY,
            "Authorization": `Bearer ${SUPABASE_API_KEY}`
          }
        });
        if (!res.ok) {
          const errText = await res.text();
          throw new Error(`删除失败: ${res.status} - ${errText}`);
        }
      }
      fetchRecords();
    } catch (e) {
      alert('删除数据时出错: ' + e.message);
      console.error(e);
    }
  }

  function printTable() {
    window.print();
  }

  window.onload = fetchRecords;
</script>

</body>
</html>
