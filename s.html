<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sistem Gudang Multi-Rak Supabase ‚Äî FINAL</title>
<style>
:root{
  --bg:#f8fafc;--accent:#10b981;--accent-dark:#059669;--text:#111827;
  --muted:#6b7280;--border:#e5e7eb;--alert:#ef4444;--alert-dark:#b91c1c;
}
body{font-family:Inter,system-ui,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:20px}
h1{font-size:22px;font-weight:700;margin-bottom:14px}
.toolbar{display:flex;flex-wrap:wrap;align-items:center;gap:10px;margin-bottom:20px}
select,input,button{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:white;font-size:14px}
input[type="text"],input[type="number"]{flex:1;min-width:120px}
button{background:var(--accent);color:#fff;cursor:pointer;transition:all .15s}
button:hover{background:var(--accent-dark)}
#status{font-size:14px;margin-bottom:10px;color:var(--muted)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:14px}
.box{border-radius:16px;padding:20px 10px;text-align:center;font-weight:600;transition:all .15s;cursor:pointer}
.box.empty{background:#e5e7eb;color:var(--muted);border:1px dashed var(--border)}
.box.filled{background:var(--accent);color:#fff;border:2px solid var(--accent-dark)}
.box.customer{background:var(--alert);color:#fff;border:2px solid var(--alert-dark)}
.slot-id{font-size:14px;opacity:.9}
.customer{font-size:17px;font-weight:700;margin-top:8px;text-transform:uppercase;word-break:break-word}

/* Modal */
.modal{display:none;position:fixed;z-index:100;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.4)}
.modal-content{background:#fff;margin:80px auto;padding:20px;border-radius:12px;max-width:900px;max-height:80%;overflow-y:auto}
.modal-header{font-weight:700;margin-bottom:10px;font-size:18px}
.modal-close{float:right;cursor:pointer;font-weight:700;color:var(--muted)}
.modal-close:hover{color:var(--text)}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table th,.table td{border:1px solid var(--border);padding:6px;text-align:left}
.table th{background:#f3f4f6}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<h1>üì¶ Tempat Barang ‚Äî Sistem Gudang Multi-Rak</h1>

<div class="toolbar">
  <label for="rakSelect">Rak:</label>
  <select id="rakSelect"></select>

  <input type="text" id="searchInput" placeholder="üîç Cari customer..." />
  <input type="number" id="slotCountInput" min="1" />

  <button id="addSlotBtn">‚ûï Tambah Kotak</button>
  <button id="saveSlotCountBtn">üíæ Simpan</button>
  <button id="syncBtn">üîÑ Sinkronkan Data</button>
</div>

<div id="status">Status: Menghubungkan ke Supabase...</div>
<div class="grid" id="grid"></div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-content">
    <span class="modal-close" id="modalClose">&times;</span>
    <div class="modal-header" id="modalTitle">Detail Kotak</div>
    <div class="small" id="modalSubtitle"></div>
    <table class="table" id="modalTable">
      <thead>
        <tr>
          <th>id</th>
          <th>company_number</th>
          <th>packaging_quantity</th>
          <th>customer</th>
          <th>customer_order_number</th>
          <th>place</th>
          <th>packaging_time</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js";

// === GANTI jika perlu ===
const SUPABASE_URL = "https://uusljhegkvahcjkaxqkz.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1c2xqaGVna3ZhaGNqa2F4cWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODMzMTIsImV4cCI6MjA3MDA1OTMxMn0.eio4OSjH30XzfXn-9UxQRVwleGKi2dvdWo6Ggx8FW1g";
// ==========================
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const rakSelect = document.getElementById("rakSelect");
const grid = document.getElementById("grid");
const status = document.getElementById("status");
const syncBtn = document.getElementById("syncBtn");
const searchInput = document.getElementById("searchInput");
const slotCountInput = document.getElementById("slotCountInput");
const addSlotBtn = document.getElementById("addSlotBtn");
const saveSlotCountBtn = document.getElementById("saveSlotCountBtn");

const modal = document.getElementById("modal");
const modalClose = document.getElementById("modalClose");
const modalTitle = document.getElementById("modalTitle");
const modalSubtitle = document.getElementById("modalSubtitle");
const modalTableBody = document.querySelector("#modalTable tbody");

let slotPerRak = {};
let rakList = [];
let currentRak = "";
let gudangData = [];

/*
 Utilities for normalization and matching:
 - normalizeString: uppercase, trim, remove spaces
 - parsePlace: try extract prefix (letters or digits) and numeric suffix
 - formatID: create display id (prefix + zero-padded number, pad length configurable)
 - placesMatch: robust matching for many formats
*/

// Normalize generic string
const normalizeString = s => (s === null || s === undefined) ? "" : String(s).toUpperCase().trim();

// Remove non-alphanumeric except keep digits and letters
const compact = s => normalizeString(s).replace(/[^A-Z0-9]/g, "");

// Parse a place string into {prefix, num} where prefix is leading letters/digits and num is integer or null
function parsePlace(raw) {
  if (!raw && raw !== 0) return { prefix: "", num: null, raw: "" };
  const s = normalizeString(String(raw));
  // Try common patterns:
  // 1) LETTERS + DIGITS (A001, AB12)
  let m = s.match(/^([A-Z]+)[^0-9]*?(\d+)\s*$/);
  if (m) return { prefix: m[1], num: parseInt(m[2], 10), raw: s };
  // 2) DIGITS + NON + DIGITS (1-01 => rak 1 slot 1)
  m = s.match(/^(\d+)[^0-9]+(\d+)\s*$/);
  if (m) return { prefix: m[1], num: parseInt(m[2], 10), raw: s };
  // 3) DIGITS only (maybe rak is numeric and slot implied)
  m = s.match(/^(\d+)$/);
  if (m) return { prefix: m[1], num: null, raw: s };
  // 4) fallback: try last number in string as slot
  m = s.match(/(\d+)\s*$/);
  if (m) {
    const pref = s.slice(0, m.index).replace(/[^A-Z0-9]/g, "");
    return { prefix: pref || s.replace(/[^A-Z]/g, ""), num: parseInt(m[1], 10), raw: s };
  }
  // else prefix only
  return { prefix: s.replace(/[^A-Z0-9]/g, ""), num: null, raw: s };
}

// Create canonical slot ID string like "A001" with pad length
function formatID(prefix, number, pad = 2) {
  if (number === null || number === undefined) return String(prefix);
  const num = String(number).padStart(pad, "0");
  return String(prefix) + num;
}

// Determine pad length to display (based on slotCount digits or sample data)
function padLengthFor(rakId) {
  const slotCount = Number(slotPerRak[rakId]) || 100;
  return Math.max(2, String(slotCount).length);
}

// Robust place matching: returns true if a DB place matches slotId (like A01)
function placesMatch(slotPrefix, slotNumber, placeRaw) {
  if (!placeRaw) return false;
  const p = parsePlace(placeRaw);

  // If both have numeric slot numbers and prefixes exist -> compare
  if ((slotNumber !== null && slotNumber !== undefined) && (p.num !== null && p.num !== undefined)) {
    // Normalize prefixes to comparable forms:
    const aPref = String(slotPrefix || "").replace(/[^A-Z0-9]/g, "");
    const bPref = String(p.prefix || "").replace(/[^A-Z0-9]/g, "");
    if (!aPref && !bPref) {
      // both have no prefix -> compare numbers only
      return Number(slotNumber) === Number(p.num);
    }
    // If prefix matches exactly
    if (aPref === bPref) return Number(slotNumber) === Number(p.num);
    // Some DB places might use rak numeric but slotId uses letter or vice versa.
    // Try also matching if compact(placeRaw) contains compact(slotPrefix+slotNumber)
    const compactSlot = compact(String(slotPrefix || "") + String(slotNumber || ""));
    const compactPlace = compact(placeRaw);
    if (compactPlace === compactSlot) return true;
    // Also allow if compactPlace endsWith compact(slotNumber) and contains prefix somewhere
    if (compactPlace.endsWith(String(Number(slotNumber)))) {
      if (aPref && compactPlace.startsWith(aPref)) return true;
    }
    // Last resort: compare raw numbers equal and either prefix matches or one prefix is contained
    if (Number(slotNumber) === Number(p.num)) {
      if (aPref && bPref && (aPref.includes(bPref) || bPref.includes(aPref))) return true;
    }
    return false;
  }

  // If slotNumber not provided (only prefix), try flexible matching:
  const compactSlotOnly = compact(String(slotPrefix || ""));
  const compactPlace = compact(placeRaw);
  if (compactSlotOnly && compactPlace.startsWith(compactSlotOnly)) return true;

  // fallback direct compact equality
  return compactSlotOnly === compactPlace;
}

/* Format helpers */
const showStatus = txt => { status.textContent = txt; };

// Load rak configuration from DB; if empty, create defaults A-J with 100 slots
async function loadRakConfig() {
  showStatus("Status: Memuat konfigurasi rak...");
  const { data, error } = await supabase.from("rak_konfigurasi").select("rak_id,slot_count").order('rak_id');
  rakSelect.innerHTML = "";
  slotPerRak = {};
  rakList = [];

  if (error) {
    console.error("Error loadRakConfig:", error);
    // create defaults in memory only
    const letters = "ABCDEFGHIJ".split("");
    letters.forEach(r => { rakList.push(r); slotPerRak[r] = 100; });
    showStatus("‚ö†Ô∏è Gagal ambil konfigurasi rak ‚Äî memakai default A‚ÄìJ (100 slot)");
  } else if (!data || data.length === 0) {
    // create default rows in DB (A-J default 100)
    const letters = "ABCDEFGHIJ".split("");
    const payload = letters.map(r => ({ rak_id: r, slot_count: 100 }));
    try {
      await supabase.from("rak_konfigurasi").insert(payload);
      letters.forEach(r => { rakList.push(r); slotPerRak[r] = 100; });
      showStatus("Rak default A‚ÄìJ dibuat (100 slot tiap rak)");
    } catch (e) {
      console.error("Gagal insert default rak:", e);
      letters.forEach(r => { rakList.push(r); slotPerRak[r] = 100; });
      showStatus("‚ö†Ô∏è Gagal simpan rak default ‚Äî memakai default lokal A‚ÄìJ");
    }
  } else {
    data.forEach(row => {
      rakList.push(String(row.rak_id));
      slotPerRak[String(row.rak_id)] = Number(row.slot_count) || 0;
    });
    showStatus(`Konfigurasi rak dimuat (${data.length} rak).`);
  }

  // Populate dropdown
  rakList.forEach(r => {
    const o = document.createElement("option");
    o.value = r;
    o.textContent = "Rak " + r;
    rakSelect.appendChild(o);
  });

  // select first rak
  currentRak = rakList.length ? rakList[0] : "A";
  rakSelect.value = currentRak;
  slotCountInput.value = slotPerRak[currentRak] || 100;
}

// Load gudang data
async function loadData() {
  showStatus("Status: Mengambil data gudang...");
  try {
    const { data, error } = await supabase.from("gudang_penyimpanan").select("*");
    if (error) {
      console.error("Error loadData:", error);
      showStatus("‚ùå Gagal ambil data gudang");
      gudangData = [];
      render();
      return;
    }
    gudangData = data || [];
    showStatus(`${gudangData.length} baris data gudang ditemukan`);
    render();
  } catch (e) {
    console.error("Exception loadData:", e);
    showStatus("‚ùå Kesalahan saat mengambil data gudang");
    gudangData = [];
    render();
  }
}

// Main render function: draw all slots for currentRak
function render() {
  grid.innerHTML = "";
  if (!currentRak) return;

  // determine display pad length intelligently:
  const pad = padLengthFor(currentRak);
  const totalSlot = Number(slotPerRak[currentRak]) || 100;
  const q = (searchInput.value || "").trim().toLowerCase();

  for (let i = 1; i <= totalSlot; i++) {
    const id = formatID(currentRak, i, pad); // e.g. A01 or 001 depending on rak
    // For matching, supply prefix and number to placesMatch
    const prefix = String(currentRak);
    const number = i;

    // find items whose place matches this slot
    const items = gudangData.filter(d => placesMatch(prefix, number, d.place));

    // If search query present, filter by customer
    if (q) {
      const filtered = items.filter(d => (d.customer || "").toString().toLowerCase().includes(q));
      if (filtered.length === 0) continue;
      // else use filtered for display
      createBox(id, filtered);
    } else {
      createBox(id, items);
    }
  }

  slotCountInput.value = totalSlot;
  showStatus(`Menampilkan rak ${currentRak} ‚Äî ${totalSlot} slot`);
}

// Helper to create a slot box and append
function createBox(id, items) {
  const box = document.createElement("div");
  if (items.some(d => d.customer)) box.className = "box customer";
  else if (items.length) box.className = "box filled";
  else box.className = "box empty";

  box.innerHTML = `
    <div class="slot-id">${id}</div>
    <div class="customer">${items.length ? (items[0].customer || "") : ""}</div>
  `;

  box.onclick = () => {
    modalTitle.textContent = "Detail Kotak " + id;
    modalSubtitle.textContent = items.length ? `Menampilkan ${items.length} baris terkait` : "Kosong";
    modalTableBody.innerHTML = "";
    if (items.length === 0) {
      modalTableBody.innerHTML = `<tr><td colspan="7" class="small">Tidak ada data di slot ini</td></tr>`;
    } else {
      items.forEach(it => {
        modalTableBody.innerHTML += `
          <tr>
            <td>${it.id ?? "-"}</td>
            <td>${it.company_number ?? "-"}</td>
            <td>${it.packaging_quantity ?? "-"}</td>
            <td>${it.customer ?? "-"}</td>
            <td>${it.customer_order_number ?? "-"}</td>
            <td>${it.place ?? "-"}</td>
            <td>${it.packaging_time ? new Date(it.packaging_time).toLocaleString() : "-"}</td>
          </tr>
        `;
      });
    }
    modal.style.display = "block";
  };

  grid.appendChild(box);
}

// Add one slot to current rak
addSlotBtn.onclick = async () => {
  if (!currentRak) return alert("Pilih rak terlebih dahulu");
  slotPerRak[currentRak] = (Number(slotPerRak[currentRak]) || 0) + 1;
  // upsert to DB
  try {
    await supabase.from("rak_konfigurasi").upsert({ rak_id: currentRak, slot_count: slotPerRak[currentRak] });
    showStatus("Slot berhasil ditambah");
  } catch (e) {
    console.error("addSlot error:", e);
    showStatus("‚ö†Ô∏è Gagal menambahkan slot (tetap ditambahkan lokal)");
  }
  render();
};

// Save slot count from input
saveSlotCountBtn.onclick = async () => {
  if (!currentRak) return alert("Pilih rak terlebih dahulu");
  const v = Number(slotCountInput.value);
  if (!v || v < 1) return alert("Jumlah tidak valid");
  slotPerRak[currentRak] = v;
  try {
    await supabase.from("rak_konfigurasi").upsert({ rak_id: currentRak, slot_count: v });
    showStatus("Jumlah slot diperbarui di database");
  } catch (e) {
    console.error("saveSlotCount error:", e);
    showStatus("‚ö†Ô∏è Gagal menyimpan jumlah slot ke database (tetap disimpan lokal)");
  }
  render();
};

// Event handlers
rakSelect.onchange = () => {
  currentRak = rakSelect.value;
  slotCountInput.value = slotPerRak[currentRak] || 100;
  render();
};
searchInput.oninput = render;
syncBtn.onclick = loadData;

// Modal close
modalClose.onclick = () => modal.style.display = "none";
window.onclick = e => { if (e.target === modal) modal.style.display = "none"; };

// Init
(async () => {
  try {
    await loadRakConfig();
    await loadData();
  } catch (e) {
    console.error("Init error:", e);
    showStatus("‚ùå Inisialisasi gagal, periksa koneksi Supabase");
  }
})();
</script>
</body>
</html>
