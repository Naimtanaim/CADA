<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Form IQC - Cetak Barcode Otomatis</title>

<!-- JsBarcode untuk membuat barcode -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
  :root{
    --accent:#111;
    --brand:#000;
    --muted:#666;
    --card:#fff;
  }
  body {
    margin: 0;
    font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
    background: #f6f7f9;
    padding: 18px;
    color: var(--accent);
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
  }

  /* Action bar */
  .actions {
    display:flex;
    gap:10px;
    justify-content:flex-end;
    margin-bottom:12px;
  }
  button {
    background:#0b6cff;
    color:white;
    border:0;
    padding:10px 14px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
  }
  button.ghost { background:#fff; color:#0b6cff; border:1px solid #d4d9ef; }

  /* Print page preview */
  .sheet {
    background: white;
    border-radius:6px;
    padding:18px;
    box-shadow: 0 6px 18px rgba(10,12,30,0.06);
  }

  /* header layout (judul & barcode atas kanan) */
  .sheet-header {
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
  }
  .title-left {
    font-size:28px;
    font-weight:700;
    letter-spacing:1px;
  }
  .meta {
    text-align:right;
    font-size:14px;
  }
  .meta .label { color:var(--muted); font-size:12px; }

  /* form table */
  .table-wrap { margin-top:14px; overflow-x:auto; }
  table {
    width:100%;
    border-collapse:collapse;
    font-size:14px;
  }
  th, td {
    padding:8px 10px;
    border:1px solid #e6e9ef;
    vertical-align:middle;
    text-align:left;
  }
  th { background:#fafbfd; font-weight:700; color:#222; }

  input[type="text"], input[type="number"], select {
    width:100%;
    padding:8px 6px;
    border:1px solid #dfe6f2;
    border-radius:6px;
    box-sizing:border-box;
    background:white;
    font-size:13px;
  }

  .row-actions { display:flex; gap:6px; align-items:center; }
  .small {
    font-size:12px;
    color:var(--muted);
  }

  /* barcode thumbnail inside cell */
  .barcode-thumb {
    width:180px;
    height:36px;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .barcode-thumb svg, .barcode-thumb canvas { max-width:100%; max-height:100%; }

  /* Print styles */
  @media print {
    body { background: white; padding:0; }
    .actions { display: none; }
    .container { max-width: 100%; margin:0; }
    .sheet { box-shadow:none; border-radius:0; padding: 12mm; }
    input, button, .row-actions { display:none !important; }
    .barcode-input-view { display:block; }
  }

  /* Style for print-mode view text (when inputs hidden) */
  .print-text { display:none; }
  .barcode-input-view { display:none; }

  /* When JS toggles print-ready, show .print-text and hide inputs with .hide-on-print-ready */
  .print-ready .print-text { display:block; }
  .print-ready .hide-on-print-ready { display:none; }
  .print-ready .barcode-input-view { display:block; }
</style>
</head>
<body>
  <div class="container">
    <div class="actions">
      <button id="btnAddRow" type="button">Tambah Baris</button>
      <button id="btnGenerate" class="ghost" type="button">Perbarui Barcode & Tanggal</button>
      <button id="btnPrint" type="button">Cetak Form</button>
    </div>

    <div class="sheet" id="sheet">
      <div class="sheet-header">
        <div>
          <div class="title-left">IQC 轉庫單</div>
          <div style="margin-top:8px; font-size:13px; color:var(--muted);">
            <div><strong>IQC Nomor:</strong> <span id="iqcNo_view" class="print-text"></span></div>
            <div class="hide-on-print-ready" style="margin-top:6px;">
              <input id="iqcNo" type="text" readonly />
            </div>
            <div style="margin-top:6px;"><strong class="label">Tanggal:</strong>
              <span id="date_view" class="print-text"></span>
              <div class="hide-on-print-ready" style="margin-top:6px;">
                <input id="dateInput" type="text" readonly />
              </div>
            </div>
          </div>
        </div>

        <div style="width:320px; text-align:right;">
          <!-- besar barcode atas -->
          <div id="topBarcodeContainer" style="background:#fff; padding:6px; display:inline-block;"></div>
          <div style="font-size:12px; margin-top:6px; color:var(--muted);">Halaman: <span id="pageNo">1/1</span></div>
        </div>
      </div>

      <!-- utama: tabel seperti di gambar -->
      <div class="table-wrap">
        <table id="itemsTable" aria-label="Tabel barang">
          <thead>
            <tr>
              <th style="width:220px">Barcode</th>
              <th style="width:140px">No. Penerimaan</th>
              <th>Vendor</th>
              <th>Part / Item</th>
              <th style="width:90px">Qty</th>
              <th style="width:90px">Hasil</th>
              <th style="width:60px">Aksi</th>
            </tr>
          </thead>
          <tbody id="tbodyItems">
            <!-- baris akan dimasukkan via JS -->
          </tbody>
        </table>
      </div>

      <!-- area tanda tangan / catatan kecil di kanan bawah mirip foto -->
      <div style="display:flex; justify-content:flex-end; margin-top:18px;">
        <div style="width:260px; border:1px solid #e6e9ef; padding:10px; font-size:13px;">
          <div style="height:36px;"></div>
          <div style="margin-top:8px; font-size:12px; color:var(--muted);">Diperiksa / Tanggal</div>
          <div class="print-text" style="margin-top:8px;">________________________</div>
        </div>
      </div>
    </div>
  </div>

<script>
  // util: format tanggal yyyy/mm/dd -> tampilan sesuai foto (yyyy/mm/dd)
  function todayYMD(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}/${m}/${day}`;
  }

  // generate IQC number: AQC + YYYYMMDD + 3-digit random (or incremental if perlu)
  function generateIQC(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    const rnd = String(Math.floor(Math.random()*900) + 100); // 100-999
    return `AQC${y}${m}${day}${rnd}`;
  }

  // membuat satu baris input di tabel
  function createRow(data = {}){
    const tbody = document.getElementById('tbodyItems');
    const tr = document.createElement('tr');

    // default values
    const barcode = data.barcode || '';
    const recNo = data.recNo || '';
    const vendor = data.vendor || '';
    const part = data.part || '';
    const qty = data.qty || '';
    const result = data.result || 'OK';

    tr.innerHTML = `
      <td>
        <div style="display:flex; gap:8px; align-items:center;">
          <div style="flex:1;">
            <input class="hide-on-print-ready input-barcode" type="text" value="${barcode}" placeholder="scan / ketik barcode">
          </div>
          <div class="barcode-thumb barcode-preview">
            <!-- barcode thumbnail akan dibuat di sini -->
            <svg></svg>
          </div>
        </div>
        <div class="print-text" style="margin-top:6px; font-size:12px; color:var(--muted)"></div>
      </td>
      <td>
        <input class="hide-on-print-ready input-rec" type="text" value="${recNo}" placeholder="GRE2025...">
        <div class="print-text"></div>
      </td>
      <td>
        <input class="hide-on-print-ready input-vendor" type="text" value="${vendor}" placeholder="Vendor">
        <div class="print-text"></div>
      </td>
      <td>
        <input class="hide-on-print-ready input-part" type="text" value="${part}" placeholder="Part / Item">
        <div class="print-text"></div>
      </td>
      <td>
        <input class="hide-on-print-ready input-qty" type="number" value="${qty}" min="0" placeholder="0">
        <div class="print-text"></div>
      </td>
      <td>
        <select class="hide-on-print-ready input-result">
          <option ${result === 'OK' ? 'selected' : ''}>OK</option>
          <option ${result === 'NG' ? 'selected' : ''}>NG</option>
        </select>
        <div class="print-text"></div>
      </td>
      <td class="row-actions">
        <button class="hide-on-print-ready remove-btn" type="button" title="Hapus baris" style="background:#ff5252;padding:6px 8px;border-radius:8px;">H</button>
      </td>
    `;

    tbody.appendChild(tr);

    // setup barcode update
    const barcodeInput = tr.querySelector('.input-barcode');
    const preview = tr.querySelector('.barcode-preview svg');
    const printText = tr.querySelectorAll('.print-text');

    function updatePreview(){
      const val = barcodeInput.value.trim() || ' ';
      try {
        JsBarcode(preview, val, {format: "CODE128", displayValue:false, height:28, margin:0});
      } catch(e){
        // fallback: clear svg
        preview.innerHTML = '';
      }
      // set print-text under barcode to show code when in print mode
      printText[0].textContent = val;
    }
    updatePreview();

    // when barcode changes
    barcodeInput.addEventListener('input', updatePreview);

    // copy other input values to print-texts
    function updateTexts(){
      tr.querySelectorAll('td').forEach((td, idx) => {
        const inpt = td.querySelector('.hide-on-print-ready') || td.querySelector('select');
        const print = td.querySelector('.print-text');
        if(print){
          if(inpt) print.textContent = (inpt.value !== undefined ? inpt.value : '');
          else print.textContent = '';
        }
      });
    }

    // wire other inputs
    ['input-rec','input-vendor','input-part','input-qty','input-result'].forEach(cls=>{
      const el = tr.querySelector('.' + cls);
      if(el){
        el.addEventListener('input', updateTexts);
        el.addEventListener('change', updateTexts);
      }
    });
    updateTexts();

    // remove button
    tr.querySelector('.remove-btn').addEventListener('click', () => {
      tr.remove();
    });

    return tr;
  }

  // initial two rows (mirip foto)
  createRow({barcode:'GRE20251027001', recNo:'GRE20251027001', vendor:'廣嘉', part:'EG5021-PC-149', qty:'506', result:'OK'});
  createRow({barcode:'GRE20251023012', recNo:'GRE20251023012', vendor:'廣嘉', part:'EG5021-PC-149', qty:'500', result:'OK'});

  // generate top barcode and set iqc + date fields
  function refreshTop(){
    const iqc = document.getElementById('iqcNo');
    const iqcView = document.getElementById('iqcNo_view');
    const dateInput = document.getElementById('dateInput');
    const dateView = document.getElementById('date_view');

    if(!iqc.value) iqc.value = generateIQC();
    iqcView.textContent = iqc.value;
    dateInput.value = todayYMD();
    dateView.textContent = todayYMD();

    // make barcode in top container
    const topContainer = document.getElementById('topBarcodeContainer');
    topContainer.innerHTML = '<svg id="topBarcode"></svg>';
    try {
      JsBarcode('#topBarcode', iqc.value, {format:'CODE128', displayValue:true, fontSize:12, height:60, margin:6});
    } catch(e){
      // ignore
    }
  }

  // wire buttons
  document.getElementById('btnAddRow').addEventListener('click', ()=> createRow({}));

  document.getElementById('btnGenerate').addEventListener('click', refreshTop);

  document.getElementById('btnPrint').addEventListener('click', ()=>{
    // prepare print: convert inputs to text (we toggle class print-ready)
    const sheet = document.getElementById('sheet');
    sheet.classList.add('print-ready');

    // ensure top barcode & texts updated
    refreshTop();

    // for every row update print-texts (in case of changes)
    document.querySelectorAll('#tbodyItems tr').forEach(tr=>{
      // update barcode svg for print (bigger) inside each row's barcode-preview container
      const code = tr.querySelector('.input-barcode').value.trim();
      const printBarcodeContainer = tr.querySelector('.barcode-preview');
      // create a new svg for print (bigger)
      printBarcodeContainer.innerHTML = '<svg></svg>';
      try {
        JsBarcode(printBarcodeContainer.querySelector('svg'), code || ' ', {format:'CODE128', displayValue:false, height:36, margin:0});
      } catch(e){}
      // update texts under each cell
      tr.querySelectorAll('td').forEach((td)=>{
        const inpt = td.querySelector('.hide-on-print-ready') || td.querySelector('select');
        const print = td.querySelector('.print-text');
        if(print){
          print.textContent = inpt ? (inpt.value !== undefined ? inpt.value : '') : '';
        }
      });
    });

    // tiny delay to ensure barcodes render, then print
    setTimeout(()=> {
      window.print();
      // after printing, remove print-ready so user can edit again
      setTimeout(()=> {
        sheet.classList.remove('print-ready');
      }, 300);
    }, 250);
  });

  // initial refresh of top
  refreshTop();
</script>
</body>
</html>
