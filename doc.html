<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manajemen Dokumen PDF Supabase</title>
<style>
body { font-family: Arial, sans-serif; background:#f0f2f5; margin:0; padding:20px; }
h1 { text-align:center; color:#333; }
.container { max-width:900px; margin:0 auto; background:white; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
.upload-section, .search-section { text-align:center; margin-bottom:20px; }
input[type="file"], input[type="text"] { padding:8px; width:70%; margin-bottom:10px; }
button { padding:8px 16px; margin-left:5px; border:none; background:#007bff; color:white; border-radius:5px; cursor:pointer; }
button:hover { background:#0056b3; }
#status { margin-top:10px; color:green; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
table, th, td { border:1px solid #ddd; }
th, td { padding:10px; text-align:left; }
th { background:#f5f5f5; }
td a { color:#007bff; text-decoration:none; }
td a:hover { text-decoration:underline; }
.delete-btn { background:#dc3545; }
.delete-btn:hover { background:#a71d2a; }
.print-btn { background:#28a745; }
.print-btn:hover { background:#1c7430; }
/* Modal Preview */
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background: rgba(0,0,0,0.7);}
.modal-content { background:white; margin:50px auto; padding:20px; border-radius:8px; max-width:80%; height:80%; }
.close { float:right; font-size:24px; cursor:pointer; color:#333; }
iframe { width:100%; height:100%; border:none; }
</style>
</head>
<body>

<h1>Manajemen Dokumen</h1>

<div class="container">

  <div class="upload-section">
    <input type="file" id="fileInput" accept="application/pdf">
    <button id="uploadBtn">Upload PDF</button>
    <div id="status"></div>
  </div>

  <div class="search-section">
    <input type="text" id="searchQuery" placeholder="Cari dokumen...">
    <button id="searchBtn">Cari</button>
  </div>

  <table id="docTable">
    <thead>
      <tr>
        <th>Nama File</th>
        <th>Nama Asli</th>
        <th>Tanggal Upload</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="4">Memuat dokumen...</td></tr>
    </tbody>
  </table>
</div>

<div id="previewModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <iframe id="pdfPreview"></iframe>
  </div>
</div>

<!-- Supabase -->
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = 'https://uusljhegkvahcjkaxqkz.supabase.co'; // ganti sesuai project
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1c2xqaGVna3ZhaGNqa2F4cWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODMzMTIsImV4cCI6MjA3MDA1OTMxMn0.eio4OSjH30XzfXn-9UxQRVwleGKi2dvdWo6Ggx8FW1g'; // ganti sesuai project
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
const BUCKET_NAME = 'documents';

let allDocs = [];

// ===================== Upload File =====================
async function uploadFile() {
  const fileInput = document.getElementById('fileInput');
  const file = fileInput.files[0];
  const status = document.getElementById('status');

  if (!file) return alert('Silakan pilih file PDF.');

  const timestamp = Date.now();

  // ðŸ”‘ Sanitasi nama file (hapus karakter aneh, spasi â†’ underscore)
  const safeName = file.name
    .replace(/[^a-zA-Z0-9_.-]/g, "_"); // hanya huruf, angka, underscore, titik, dash
  const fileName = `${timestamp}_${safeName}`;

  status.textContent = 'Mengupload...';
  status.style.color = 'black';

  try {
    // Upload ke bucket
    const { data: uploadData, error: uploadError } = await supabase
      .storage
      .from(BUCKET_NAME)
      .upload(fileName, file);

    if (uploadError) throw uploadError;

    // Ambil public URL
    const { data: urlData, error: urlError } = supabase
      .storage
      .from(BUCKET_NAME)
      .getPublicUrl(fileName);

    if (urlError) throw urlError;
    const publicUrl = urlData.publicUrl;

    // Simpan metadata di tabel
    const { error: dbError } = await supabase.from('documents').insert([{
      file_name: fileName,
      original_name: file.name,
      uploaded_at: new Date().toISOString(),
      url: publicUrl
    }]);
    if (dbError) throw dbError;

    status.textContent = 'Upload berhasil!';
    status.style.color = 'green';
    fileInput.value = '';
    fetchDocuments();

  } catch (err) {
    console.error(err);
    status.textContent = 'Upload gagal: ' + (err.message || JSON.stringify(err));
    status.style.color = 'red';
  }
}


// ===================== Fetch Documents =====================
async function fetchDocuments() {
  try {
    const { data, error } = await supabase.from('documents').select('*').order('uploaded_at', { ascending:false });
    if(error) throw error;

    allDocs = data.map(d=>({
      name: d.file_name,
      original: d.original_name,
      url: d.url,
      created_at: new Date(d.uploaded_at).toLocaleString()
    }));

    displayDocuments(allDocs);

  } catch(err) {
    console.error(err);
    document.querySelector('#docTable tbody').innerHTML = '<tr><td colspan="4">Gagal memuat dokumen: '+ (err.message||JSON.stringify(err)) +'</td></tr>';
  }
}

// ===================== Display =====================
function displayDocuments(docs){
  const tbody = document.querySelector('#docTable tbody');
  tbody.innerHTML = '';
  if(!docs.length){ tbody.innerHTML = '<tr><td colspan="4">Tidak ada dokumen.</td></tr>'; return; }

  docs.forEach(doc=>{
    const tr = document.createElement('tr');

    const tdName = document.createElement('td');
    const aName = document.createElement('a');
    aName.href='#';
    aName.textContent = doc.name;
    aName.addEventListener('click', ()=>previewDocument(doc.url));
    tdName.appendChild(aName);

    const tdOriginal = document.createElement('td');
    tdOriginal.textContent = doc.original;

    const tdDate = document.createElement('td');
    tdDate.textContent = doc.created_at;

    const tdAction = document.createElement('td');

    const printBtn = document.createElement('button');
    printBtn.textContent='Print';
    printBtn.className='print-btn';
    printBtn.addEventListener('click', ()=>printDocument(doc.url));

    const deleteBtn = document.createElement('button');
    deleteBtn.textContent='Hapus';
    deleteBtn.className='delete-btn';
    deleteBtn.addEventListener('click', async ()=>{
      if(!confirm(`Hapus ${doc.name}?`)) return;
      try {
        const { error: delError } = await supabase.storage.from(BUCKET_NAME).remove([doc.name]);
        if(delError) throw delError;
        const { error: dbError } = await supabase.from('documents').delete().eq('file_name', doc.name);
        if(dbError) throw dbError;
        await fetchDocuments();
      } catch(err){
        console.error(err);
        alert('Gagal menghapus: '+(err.message||JSON.stringify(err)));
      }
    });

    tdAction.appendChild(printBtn);
    tdAction.appendChild(deleteBtn);

    tr.appendChild(tdName);
    tr.appendChild(tdOriginal);
    tr.appendChild(tdDate);
    tr.appendChild(tdAction);

    tbody.appendChild(tr);
  });
}

// ===================== Print & Preview =====================
function printDocument(url){
  const win = window.open(url);
  win.addEventListener('load', ()=>{ win.print(); }, { once:true });
}

function previewDocument(url){
  const modal = document.getElementById('previewModal');
  const iframe = document.getElementById('pdfPreview');
  iframe.src = url;
  modal.style.display='block';
}

document.getElementById('closeModal').addEventListener('click', ()=>{
  document.getElementById('previewModal').style.display='none';
  document.getElementById('pdfPreview').src='';
});

// ===================== Search =====================
function searchDocuments(){
  const query = document.getElementById('searchQuery').value.toLowerCase();
  const filtered = allDocs.filter(d=>d.name.toLowerCase().includes(query) || d.original.toLowerCase().includes(query));
  displayDocuments(filtered);
}

// ===================== Event Listeners =====================
document.getElementById('uploadBtn').addEventListener('click', uploadFile);
document.getElementById('searchBtn').addEventListener('click', searchDocuments);

// ===================== Init =====================
await fetchDocuments(); // Top-level await aman karena type="module"
</script>
</body>
</html>
