<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Import Excel ke Supabase via REST API</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <h2>Import Excel ke Supabase via REST API</h2>
  <input type="file" id="inputExcel" accept=".xlsx,.xls" />
  <button id="btnUpload">Upload ke Supabase</button>

  <script>
    // Ganti ini dengan URL Supabase dan anon key kamu
    const SUPABASE_URL = 'https://uusljhegkvahcjkaxqkz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1c2xqaGVna3ZhaGNqa2F4cWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODMzMTIsImV4cCI6MjA3MDA1OTMxMn0.eio4OSjH30XzfXn-9UxQRVwleGKi2dvdWo6Ggx8FW1g';

    let jsonData = [];

    document.getElementById('inputExcel').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return alert('Pilih file Excel terlebih dahulu');

      const reader = new FileReader();
      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: null });
        console.log('Data dari Excel:', jsonData);
        alert(`File berhasil dibaca, baris: ${jsonData.length}`);
      };
      reader.readAsArrayBuffer(file);
    });

    document.getElementById('btnUpload').addEventListener('click', async function() {
      if (jsonData.length === 0) {
        return alert('Belum ada data Excel yang dibaca');
      }

      const mappedData = jsonData.map(row => ({
        packaging_board: row['packaging_board'],
        box_number: row['box_number'],
        material_order_number: row['material_order_number'],
        original_material_order_number: row['original_material_order_number'],
        company_number: row['company_number'],
        packaging_quantity: row['packaging_quantity'] ? parseInt(row['packaging_quantity']) : null,
        customer: row['customer'],
        customer_order_number: row['customer_order_number'],
        delivery_order_number: row['delivery_order_number'],
        packaging_time: row['packaging_time'] ? new Date(row['packaging_time']).toISOString() : null,
        packer: row['packer']
      }));

      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/data`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(mappedData)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Error upload data');
        }

        const result = await response.json();
        alert(`Berhasil upload ${result.length} baris ke Supabase`);
        console.log('Response:', result);

      } catch (error) {
        console.error('Error upload data:', error);
        alert('Error upload data: ' + error.message);
      }
    });
  </script>
</body>
</html>
