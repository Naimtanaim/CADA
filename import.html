<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Import CSV to Supabase</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>
  <h2>📦 匯入 CSV 至資料庫</h2>
  <input type="file" id="csvFile" accept=".csv">
  <button onclick="handleUpload()">📤 上傳並匯入</button>

  <script>
    // Ganti dengan URL dan API KEY kamu
    const supabaseUrl = 'https://uusljhegkvahcjkaxqkz.supabase.co';
    const supabaseKey = 'YOUR_SUPABASE_API_KEY';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    async function handleUpload() {
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];

      if (!file) {
        alert('請選擇一個CSV檔案');
        return;
      }

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: async function(results) {
          const rows = results.data;
          console.log('📄 解析筆數:', rows.length);

          // Validasi kolom wajib
          const requiredCols = [
            '包裝機板', '箱號', '備料單號', '原始備料單號',
            '公司號', '包裝數量', '客戶', '客戶訂單號',
            '送貨訂單號', '打包時間', '打包人員'
          ];

          const invalidCols = requiredCols.filter(col => !(col in rows[0]));
          if (invalidCols.length > 0) {
            alert('CSV 欄位錯誤或缺失：' + invalidCols.join(', '));
            return;
          }

          // Mapping dan insert satu per satu
          for (const row of rows) {
            const { error } = await supabase
              .from('databarang')
              .insert([{
                packaging_board: row['包裝機板'],
                box_number: row['箱號'],
                material_order_number: row['備料單號'],
                original_material_order_number: row['原始備料單號'],
                company_number: row['公司號'],
                packaging_quantity: parseInt(row['包裝數量']) || 0,
                customer: row['客戶'],
                customer_order_number: row['客戶訂單號'],
                delivery_order_number: row['送貨訂單號'],
                packaging_time: row['打包時間'] ? new Date(row['打包時間']).toISOString() : null,
                packer: row['打包人員']
              }]);

            if (error) {
              console.error('❌ Gagal simpan:', error);
              alert('發生錯誤: ' + error.message);
              return;
            }
          }

          alert('✅ 匯入成功，共 ' + rows.length + ' 筆資料');
          fileInput.value = '';
        }
      });
    }
  </script>
</body>
</html>
