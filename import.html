<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>åŒ¯å…¥ Excel è‡³ Supabase</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h2>ğŸ“¥ ä¸Šå‚³ Excel æª”æ¡ˆ (.xlsx)</h2>
  <input type="file" id="excelFile" accept=".xlsx">
  <button onclick="handleExcelUpload()">ä¸Šå‚³ä¸¦åŒ¯å…¥</button>

  <script>
    // GANTI dengan Supabase URL dan API KEY kamu
    const supabaseUrl = 'https://uusljhegkvahcjkaxqkz.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1c2xqaGVna3ZhaGNqa2F4cWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODMzMTIsImV4cCI6MjA3MDA1OTMxMn0.eio4OSjH30XzfXn-9UxQRVwleGKi2dvdWo6Ggx8FW1g';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    async function handleExcelUpload() {
      const fileInput = document.getElementById('excelFile');
      const file = fileInput.files[0];
      if (!file) {
        alert('è«‹é¸æ“‡ä¸€å€‹Excelæª”æ¡ˆ');
        return;
      }

      const reader = new FileReader();
      reader.onload = async function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);

        if (!json.length) {
          alert('Excel æª”æ¡ˆå…§å®¹ç‚ºç©º');
          return;
        }

        // Pastikan kolom cocok
        const requiredCols = [
          'åŒ…è£æ©Ÿæ¿', 'ç®±è™Ÿ', 'å‚™æ–™å–®è™Ÿ', 'åŸå§‹å‚™æ–™å–®è™Ÿ',
          'å…¬å¸è™Ÿ', 'åŒ…è£æ•¸é‡', 'å®¢æˆ¶', 'å®¢æˆ¶è¨‚å–®è™Ÿ',
          'é€è²¨è¨‚å–®è™Ÿ', 'æ‰“åŒ…æ™‚é–“', 'æ‰“åŒ…äººå“¡'
        ];

        const missingCols = requiredCols.filter(col => !(col in json[0]));
        if (missingCols.length > 0) {
          alert('ç¼ºå°‘å¿…è¦æ¬„ä½ï¼š' + missingCols.join(', '));
          return;
        }

        for (const row of json) {
          const { error } = await supabase
            .from('data')
            .insert([{
              packaging_board: row['åŒ…è£æ©Ÿæ¿'],
              box_number: row['ç®±è™Ÿ'],
              material_order_number: row['å‚™æ–™å–®è™Ÿ'],
              original_material_order_number: row['åŸå§‹å‚™æ–™å–®è™Ÿ'],
              company_number: row['å…¬å¸è™Ÿ'],
              packaging_quantity: parseInt(row['åŒ…è£æ•¸é‡']) || 0,
              customer: row['å®¢æˆ¶'],
              customer_order_number: row['å®¢æˆ¶è¨‚å–®è™Ÿ'],
              delivery_order_number: row['é€è²¨è¨‚å–®è™Ÿ'],
              packaging_time: row['æ‰“åŒ…æ™‚é–“'] ? new Date(row['æ‰“åŒ…æ™‚é–“']).toISOString() : null,
              packer: row['æ‰“åŒ…äººå“¡']
            }]);

          if (error) {
            console.error('âŒ ç™¼ç”ŸéŒ¯èª¤:', error);
            alert('âŒ æ’å…¥è³‡æ–™å¤±æ•—: ' + error.message);
            return;
          }
        }

        alert('âœ… åŒ¯å…¥æˆåŠŸï¼Œå…± ' + json.length + ' ç­†è³‡æ–™');
        fileInput.value = '';
      };

      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
