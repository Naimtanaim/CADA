<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Import CSV to Supabase</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>
  <h2>ğŸ“¦ åŒ¯å…¥ CSV è‡³è³‡æ–™åº«</h2>
  <input type="file" id="csvFile" accept=".csv">
  <button onclick="handleUpload()">ğŸ“¤ ä¸Šå‚³ä¸¦åŒ¯å…¥</button>

  <script>
    // Ganti dengan URL dan API KEY kamu
    const supabaseUrl = 'https://uusljhegkvahcjkaxqkz.supabase.co';
    const supabaseKey = 'YOUR_SUPABASE_API_KEY';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    async function handleUpload() {
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];

      if (!file) {
        alert('è«‹é¸æ“‡ä¸€å€‹CSVæª”æ¡ˆ');
        return;
      }

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: async function(results) {
          const rows = results.data;
          console.log('ğŸ“„ è§£æç­†æ•¸:', rows.length);

          // Validasi kolom wajib
          const requiredCols = [
            'åŒ…è£æ©Ÿæ¿', 'ç®±è™Ÿ', 'å‚™æ–™å–®è™Ÿ', 'åŸå§‹å‚™æ–™å–®è™Ÿ',
            'å…¬å¸è™Ÿ', 'åŒ…è£æ•¸é‡', 'å®¢æˆ¶', 'å®¢æˆ¶è¨‚å–®è™Ÿ',
            'é€è²¨è¨‚å–®è™Ÿ', 'æ‰“åŒ…æ™‚é–“', 'æ‰“åŒ…äººå“¡'
          ];

          const invalidCols = requiredCols.filter(col => !(col in rows[0]));
          if (invalidCols.length > 0) {
            alert('CSV æ¬„ä½éŒ¯èª¤æˆ–ç¼ºå¤±ï¼š' + invalidCols.join(', '));
            return;
          }

          // Mapping dan insert satu per satu
          for (const row of rows) {
            const { error } = await supabase
              .from('databarang')
              .insert([{
                packaging_board: row['åŒ…è£æ©Ÿæ¿'],
                box_number: row['ç®±è™Ÿ'],
                material_order_number: row['å‚™æ–™å–®è™Ÿ'],
                original_material_order_number: row['åŸå§‹å‚™æ–™å–®è™Ÿ'],
                company_number: row['å…¬å¸è™Ÿ'],
                packaging_quantity: parseInt(row['åŒ…è£æ•¸é‡']) || 0,
                customer: row['å®¢æˆ¶'],
                customer_order_number: row['å®¢æˆ¶è¨‚å–®è™Ÿ'],
                delivery_order_number: row['é€è²¨è¨‚å–®è™Ÿ'],
                packaging_time: row['æ‰“åŒ…æ™‚é–“'] ? new Date(row['æ‰“åŒ…æ™‚é–“']).toISOString() : null,
                packer: row['æ‰“åŒ…äººå“¡']
              }]);

            if (error) {
              console.error('âŒ Gagal simpan:', error);
              alert('ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
              return;
            }
          }

          alert('âœ… åŒ¯å…¥æˆåŠŸï¼Œå…± ' + rows.length + ' ç­†è³‡æ–™');
          fileInput.value = '';
        }
      });
    }
  </script>
</body>
</html>
